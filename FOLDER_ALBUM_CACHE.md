# 文件夹级别专辑统一识别功能

## 功能概述

针对大型专辑（如原声带、合辑），通过文件夹级别的专辑统一识别，避免同一专辑的歌曲被分散到不同版本的专辑中。

## 问题场景

在处理大型专辑时，如果每首歌单独识别，可能会出现以下问题：
- 同一张专辑的歌曲被识别为不同版本（如初回限定版、通常版、数字版等）
- 最终导致文件被分散到多个文件夹中
- 专辑完整性被破坏

## 解决方案

### 核心机制

1. **样本收集阶段**
   - 文件夹内前5首歌作为样本
   - 收集每首歌的识别结果

2. **投票与分析**
   - 统计专辑出现频率
   - 对于大型专辑（≥10首），优先选择曲目数最接近文件夹内文件数的版本
   - 对于小型专辑，主要看投票数

3. **置信度验证**
   - 需要≥60%的歌曲匹配同一专辑才确定
   - 确定后，文件夹内所有歌曲统一使用该专辑信息

4. **异常检测与回退**
   - 后续歌曲识别结果与缓存不匹配时，累计计数
   - 不匹配次数≥3次，清除缓存，重新评估

## 工作流程

```
文件1 识别 → 添加样本1 → 继续收集
文件2 识别 → 添加样本2 → 继续收集
文件3 识别 → 添加样本3 → 继续收集
文件4 识别 → 添加样本4 → 继续收集
文件5 识别 → 添加样本5 → 分析样本
                          ↓
                    投票选出最佳专辑
                          ↓
                    验证置信度(≥60%)
                          ↓
                    缓存专辑信息
                          ↓
文件6 识别 → 验证匹配 → 使用缓存专辑
文件7 识别 → 验证匹配 → 使用缓存专辑
...
文件N 识别 → 验证不匹配 → 累计不匹配次数
            (不匹配≥3次) → 清除缓存，重新评估
```

## 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| SAMPLE_SIZE | 5 | 样本收集数量 |
| CONFIDENCE_THRESHOLD | 0.6 | 置信度阈值（60%） |
| LARGE_ALBUM_THRESHOLD | 10 | 大型专辑阈值（10首） |
| TRACK_COUNT_TOLERANCE | 0.3 | 曲目数容差（30%） |
| MISMATCH_LIMIT | 3 | 不匹配次数上限 |

## 日志示例

### 样本收集阶段
```
添加专辑识别样本: 01 - Track1.flac - Album Name (样本数: 1/5)
添加专辑识别样本: 02 - Track2.flac - Album Name (样本数: 2/5)
...
添加专辑识别样本: 05 - Track5.flac - Album Name (样本数: 5/5)
```

### 分析与确定阶段
```
开始分析文件夹专辑样本: 样本数=5, 文件夹音乐文件数=22, 大型专辑=true
专辑投票结果: Artist - Album Name (投票数: 5, 曲目数: 22)
  -> 曲目数匹配良好 (匹配率: 100.0%)
最佳专辑置信度: 100.0% (5票/5样本)
✓ 确定文件夹专辑: Artist - Album Name (22首曲目)
```

### 应用缓存阶段
```
✓ 使用文件夹统一专辑: Album Name (置信度: 100.0%)
```

### 异常检测阶段
```
歌曲识别结果与文件夹专辑不匹配: 15 - Track15.flac - 期望: Album A, 实际: Album B (不匹配次数: 1)
...
不匹配次数过多，清除文件夹专辑缓存，触发重新评估
```

## 适用场景

✅ **适用**
- 大型原声带（15-50首）
- 动画/游戏音乐合辑
- 完整专辑下载（10首以上）

❌ **不适用**（功能自动禁用）
- 单曲或迷你专辑（<10首）
- 精选集或混合专辑
- 不同专辑混在一个文件夹

## 技术实现

### 核心类
- `FolderAlbumCache`: 文件夹专辑缓存管理器
- `AlbumSampleCollector`: 样本收集器
- `CachedAlbumInfo`: 缓存的专辑信息
- `AlbumIdentificationInfo`: 专辑识别信息

### 集成点
- `Main.applyFolderAlbumCache()`: 专辑统一处理入口
- 在MusicBrainz识别后、文件处理前调用

## 优势

1. **提高专辑完整性**: 同一专辑的所有歌曲归档到同一个文件夹
2. **减少版本混乱**: 避免同一专辑分散到多个版本
3. **智能回退机制**: 异常情况自动重新评估
4. **性能优化**: 样本收集后直接应用缓存，减少重复分析

## 注意事项

1. **文件夹组织**: 建议一个文件夹只放一张专辑
2. **下载顺序**: 文件顺序会影响样本收集，建议按曲目顺序下载
3. **混合专辑**: 如果文件夹包含多张专辑，可能导致识别混乱
4. **重新处理**: 如需重新识别，删除处理历史记录即可

## 未来优化方向

1. **样本大小自适应**: 根据文件夹大小动态调整样本数量
2. **版本偏好配置**: 允许用户设置优先选择的专辑版本类型
3. **人工干预接口**: 提供API手动指定文件夹的专辑信息
4. **统计报告**: 生成专辑识别准确率报告